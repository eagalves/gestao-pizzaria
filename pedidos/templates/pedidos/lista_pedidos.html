{% extends "autenticacao/pizzaria_dashboard.html" %}

{% block title %}Pedidos - Gestão Pizzaria{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Pedidos</h2>
    <button class="btn btn-orange" data-bs-toggle="modal" data-bs-target="#modalNovoPedido">
        <i class="fas fa-plus me-2"></i>Novo Pedido
    </button>
</div>

<div class="d-flex gap-3 mb-3">
    <div class="flex-grow-1 position-relative">
        <input type="text" class="form-control ps-5" placeholder="Buscar por cliente ou código...">
        <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
    </div>
    <button class="btn btn-outline-secondary d-flex align-items-center gap-2">
        <i class="fas fa-filter"></i>
        Filtros
    </button>
</div>

<div class="table-responsive">
    <table class="table align-middle">
        <thead class="table-light">
            <tr>
                <th>#</th>
                <th>Cliente</th>
                <th>Data/Hora</th>
                <th>Total</th>
                <th>Status</th>
                <th class="text-end">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for pedido in pedidos %}
                <tr>
                    <td>{{ pedido.id }}</td>
                    <td>{{ pedido.cliente_nome }}</td>
                    <td>{{ pedido.data_criacao }}</td>
                    <td>R$ {{ pedido.total|floatformat:2 }}</td>
                    <td>
                        <div class="dropdown dropup">
                            <button class="btn btn-sm dropdown-toggle status-badge-{{ pedido.status|lower }}" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="true">
                                {{ pedido.get_status_display }}
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                {% for status_code, status_name in status_choices %}
                                    {% if status_code != pedido.status %}
                                        <li><a class="dropdown-item alterar-status" href="#" data-pedido-id="{{ pedido.id }}" data-status="{{ status_code }}">
                                            <span class="status-indicator status-{{ status_code|lower }}"></span>
                                            {{ status_name }}
                                        </a></li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <!-- Ações rápidas para status mais comuns -->
                        {% if pedido.status == 'RECEBIDO' %}
                            <div class="mt-1">
                                <button class="btn btn-xs btn-outline-warning quick-status" data-pedido-id="{{ pedido.id }}" data-status="EM_PREPARO" title="Iniciar preparo">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        {% elif pedido.status == 'EM_PREPARO' %}
                            <div class="mt-1">
                                <button class="btn btn-xs btn-outline-success quick-status" data-pedido-id="{{ pedido.id }}" data-status="PRONTO" title="Marcar como pronto">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        {% elif pedido.status == 'PRONTO' %}
                            <div class="mt-1">
                                <button class="btn btn-xs btn-outline-primary quick-status" data-pedido-id="{{ pedido.id }}" data-status="ENTREGUE" title="Marcar como entregue">
                                    <i class="fas fa-truck"></i>
                                </button>
                            </div>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        <a href="#" class="text-orange me-3" data-bs-toggle="modal" data-bs-target="#modalDetalhesPedido"><i class="fas fa-eye"></i></a>
                        <a href="#" class="text-orange me-3" data-bs-toggle="modal" data-bs-target="#modalEditarPedido"><i class="fas fa-edit"></i></a>
                        <a href="#" class="text-danger" onclick="return confirm('Cancelar este pedido?');"><i class="fas fa-times-circle"></i></a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-5 text-muted">Nenhum pedido registrado</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal Novo Pedido -->
<div class="modal fade" id="modalNovoPedido" tabindex="-1" aria-labelledby="modalNovoPedidoLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <form method="post" action="#" id="formNovoPedido">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="modalNovoPedidoLabel">Novo Pedido</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label">Cliente (opcional)</label>
              <input type="text" class="form-control" name="cliente_nome" placeholder="Nome do cliente">
            </div>
            <div class="col-md-6">
              <label class="form-label">Telefone</label>
              <input type="text" class="form-control" name="cliente_telefone" placeholder="(xx) xxxxx-xxxx">
            </div>
          </div>

          <h6>Itens do Pedido</h6>
          <div class="border rounded p-3 mb-2">
            <div id="itens-pedido-lista"></div>
            <button type="button" class="btn btn-outline-secondary" id="btn-add-item">
              <i class="fas fa-plus me-2"></i>Adicionar Item
            </button>
          </div>

          <div class="d-flex justify-content-end">
            <h5>Subtotal: R$ <span id="subtotal">0.00</span></h5>
          </div>

          <hr>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Forma de Pagamento</label>
              <select class="form-select" name="forma_pagamento" required>
                <option value="DIN">Dinheiro</option>
                <option value="PIX">Pix</option>
                <option value="CC">Cartão Crédito</option>
                <option value="CD">Cartão Débito</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Observações do Pedido</label>
              <input type="text" class="form-control" name="observacoes" placeholder="Ex.: Sem cebola em metade da pizza">
            </div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between align-items-center">
          <div>
            <strong>Total: R$ <span id="total-geral">0.00</span></strong>
          </div>
          <div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-orange">Salvar Pedido</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let itemCount = 0;
const produtos = [
  {% for p in produtos_disponiveis %}
    {id: {{ p.id }}, nome: "{{ p.nome|escapejs }}", preco: {{ p.preco_atual }}},
  {% endfor %}
];

function atualizarTotais() {
  const subtotalSpan = document.getElementById('subtotal');
  const totalSpan = document.getElementById('total-geral');
  let subtotal = 0;
  document.querySelectorAll('.item-row').forEach(row => {
    const preco = parseFloat(row.dataset.preco);
    const qtd = parseFloat(row.querySelector('.qtd-input').value) || 0;
    subtotal += preco * qtd;
  });
  subtotalSpan.textContent = subtotal.toFixed(2);
  totalSpan.textContent = subtotal.toFixed(2); // Sem taxa por enquanto
}

document.getElementById('btn-add-item').addEventListener('click', () => {
  itemCount++;
  const lista = document.getElementById('itens-pedido-lista');
  const row = document.createElement('div');
  row.className = 'row g-2 align-items-end mb-2 item-row';
  row.dataset.preco = 0;
  row.innerHTML = `
    <div class="col-md-5">
      <label class="form-label">Produto</label>
      <select class="form-select prod-select" name="item_produto_${itemCount}" required>
        <option value="">Selecione</option>
        ${produtos.map(p => `<option value="${p.id}" data-preco="${p.preco}">${p.nome}</option>`).join('')}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Qtd.</label>
      <input type="number" min="1" value="1" class="form-control qtd-input" name="item_qtd_${itemCount}" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Obs.</label>
      <input type="text" class="form-control" name="item_obs_${itemCount}">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="this.closest('.item-row').remove(); atualizarTotais();"><i class="fas fa-trash"></i></button>
    </div>
  `;
  lista.appendChild(row);

  // Eventos para atualizar preço
  row.querySelector('.prod-select').addEventListener('change', function() {
    const price = parseFloat(this.selectedOptions[0].dataset.preco || 0);
    row.dataset.preco = price;
    atualizarTotais();
  });
  row.querySelector('.qtd-input').addEventListener('input', atualizarTotais);
});

// Função para alterar status do pedido
function alterarStatus(pedidoId, novoStatus, statusNome, elemento) {
  if (confirm(`Alterar status do pedido #${pedidoId} para "${statusNome}"?`)) {
    // Mostrar loading no elemento
    const originalContent = elemento.innerHTML;
    elemento.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    elemento.disabled = true;
    
    // Fazer requisição AJAX
    fetch(`/pedidos/${pedidoId}/alterar-status/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: `status=${novoStatus}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Recarregar a página para atualizar a interface
        location.reload();
      } else {
        alert('Erro: ' + (data.error || 'Erro desconhecido'));
        elemento.innerHTML = originalContent;
        elemento.disabled = false;
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao alterar status do pedido');
      elemento.innerHTML = originalContent;
      elemento.disabled = false;
    });
  }
}

// Event listeners
document.addEventListener('click', function(e) {
  // Dropdown de status
  if (e.target.classList.contains('alterar-status')) {
    e.preventDefault();
    
    const pedidoId = e.target.getAttribute('data-pedido-id');
    const novoStatus = e.target.getAttribute('data-status');
    const statusNome = e.target.textContent.trim();
    
    alterarStatus(pedidoId, novoStatus, statusNome, e.target);
  }
  
  // Botões de ação rápida
  if (e.target.closest('.quick-status')) {
    e.preventDefault();
    
    const button = e.target.closest('.quick-status');
    const pedidoId = button.getAttribute('data-pedido-id');
    const novoStatus = button.getAttribute('data-status');
    
    // Mapear status para nomes amigáveis
    const statusNames = {
      'EM_PREPARO': 'Em Preparo',
      'PRONTO': 'Pronto',
      'ENTREGUE': 'Entregue'
    };
    
    const statusNome = statusNames[novoStatus] || novoStatus;
    alterarStatus(pedidoId, novoStatus, statusNome, button);
  }
});
</script>

<style>
/* Estilos para os badges de status */
.status-badge-rascunho {
  background-color: #6c757d;
  color: white;
  border: none;
}

.status-badge-recebido {
  background-color: #ffc107;
  color: #212529;
  border: none;
}

.status-badge-em_preparo {
  background-color: #fd7e14;
  color: white;
  border: none;
}

.status-badge-pronto {
  background-color: #20c997;
  color: white;
  border: none;
}

.status-badge-entregue {
  background-color: #198754;
  color: white;
  border: none;
}

.status-badge-cancelado {
  background-color: #dc3545;
  color: white;
  border: none;
}

.status-badge-rascunho:hover,
.status-badge-recebido:hover,
.status-badge-em_preparo:hover,
.status-badge-pronto:hover,
.status-badge-entregue:hover,
.status-badge-cancelado:hover {
  opacity: 0.8;
}

/* Indicadores de status no dropdown */
.status-indicator {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 8px;
}

.status-rascunho { background-color: #6c757d; }
.status-recebido { background-color: #ffc107; }
.status-em_preparo { background-color: #fd7e14; }
.status-pronto { background-color: #20c997; }
.status-entregue { background-color: #198754; }
.status-cancelado { background-color: #dc3545; }

/* Botões de ação rápida */
.btn-xs {
  padding: 0.125rem 0.25rem;
  font-size: 0.75rem;
  line-height: 1;
  border-radius: 0.2rem;
}

.quick-status {
  transition: all 0.2s ease;
}

.quick-status:hover {
  transform: scale(1.1);
}

/* Melhorar dropdown para não precisar scroll */
.dropdown-menu {
  max-height: none !important;
  overflow: visible !important;
}

/* Forçar dropdown para cima quando necessário */
.table tbody tr:nth-last-child(-n+3) .dropdown {
  position: static;
}

.table tbody tr:nth-last-child(-n+3) .dropdown-menu {
  position: absolute;
  bottom: 100%;
  top: auto;
  transform: translateY(-5px);
}

/* Ajustar largura da coluna de status */
.table th:nth-child(5),
.table td:nth-child(5) {
  min-width: 140px;
  width: 140px;
}
</style>
{% endblock %}
