{% extends "autenticacao/pizzaria_dashboard.html" %}

{% block title %}Pedidos - Gestão Pizzaria{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Pedidos</h2>
    <button class="btn btn-orange" data-bs-toggle="modal" data-bs-target="#modalNovoPedido">
        <i class="fas fa-plus me-2"></i>Novo Pedido
    </button>
</div>

<div class="d-flex gap-3 mb-3">
    <div class="flex-grow-1 position-relative">
        <input type="text" class="form-control ps-5" placeholder="Buscar por cliente ou código...">
        <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
    </div>
    <button class="btn btn-outline-secondary d-flex align-items-center gap-2">
        <i class="fas fa-filter"></i>
        Filtros
    </button>
</div>

<div class="table-responsive">
    <table class="table align-middle">
        <thead class="table-light">
            <tr>
                <th>#</th>
                <th>Cliente</th>
                <th>Data/Hora</th>
                <th>Total</th>
                <th>Status</th>
                <th>Obs.</th>
                <th class="text-end">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for pedido in pedidos %}
                <tr>
                    <td>{{ pedido.id }}</td>
                    <td>{{ pedido.get_cliente_nome }}</td>
                    <td>{{ pedido.data_criacao }}</td>
                    <td>R$ {{ pedido.total|floatformat:2 }}</td>
                    <td>
                        <div class="dropdown dropup">
                            <button class="btn btn-sm dropdown-toggle status-badge-{{ pedido.status|lower }}" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="true">
                                {{ pedido.get_status_display }}
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                {% for status_code, status_name in status_choices %}
                                    {% if status_code != pedido.status %}
                                        <li><a class="dropdown-item alterar-status" href="#" data-pedido-id="{{ pedido.id }}" data-status="{{ status_code }}">
                                            <span class="status-indicator status-{{ status_code|lower }}"></span>
                                            {{ status_name }}
                                        </a></li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <!-- Ações rápidas para status mais comuns -->
                        {% if pedido.status == 'RECEBIDO' %}
                            <div class="mt-1">
                                <button class="btn btn-xs btn-outline-warning quick-status" data-pedido-id="{{ pedido.id }}" data-status="EM_PREPARO" title="Iniciar preparo">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        {% elif pedido.status == 'EM_PREPARO' %}
                            <div class="mt-1">
                                <button class="btn btn-xs btn-outline-success quick-status" data-pedido-id="{{ pedido.id }}" data-status="PRONTO" title="Marcar como pronto">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        {% elif pedido.status == 'PRONTO' %}
                            <div class="mt-1">
                                <button class="btn btn-xs btn-outline-primary quick-status" data-pedido-id="{{ pedido.id }}" data-status="ENTREGUE" title="Marcar como entregue">
                                    <i class="fas fa-truck"></i>
                                </button>
                            </div>
                        {% endif %}
                    </td>
                    <td>
                        {% if pedido.observacoes %}
                            <i class="fas fa-comment text-info" title="{{ pedido.observacoes }}" data-bs-toggle="tooltip"></i>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        <a href="#" class="text-orange me-3 btn-detalhes" data-pedido-id="{{ pedido.id }}" title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="#" class="text-orange me-3 btn-editar" data-pedido-id="{{ pedido.id }}" title="Editar pedido">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="#" class="text-danger btn-cancelar" data-pedido-id="{{ pedido.id }}" title="Cancelar pedido">
                            <i class="fas fa-times-circle"></i>
                        </a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-5 text-muted">Nenhum pedido registrado</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal Novo Pedido -->
<div class="modal fade" id="modalNovoPedido" tabindex="-1" aria-labelledby="modalNovoPedidoLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <form method="post" action="#" id="formNovoPedido">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="modalNovoPedidoLabel">Novo Pedido</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3 mb-3">
            <div class="col-12">
                <label class="form-label">Cliente</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="busca-cliente" placeholder="Digite nome ou telefone para buscar cliente..." autocomplete="off">
                    <button type="button" class="btn btn-outline-secondary" id="btn-cliente-novo">
                        <i class="fas fa-user-plus"></i> Novo
                    </button>
                </div>
                <div id="lista-clientes" class="position-absolute w-100 bg-white border rounded-bottom shadow-sm" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
            </div>
            
            <!-- Cliente selecionado (hidden) -->
            <input type="hidden" id="cliente-selecionado-id" name="cliente_id">
            
            <!-- Campos para cliente não cadastrado -->
            <div id="campos-cliente-novo" class="col-12" style="display: none;">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Nome do Cliente</label>
                        <input type="text" class="form-control" name="cliente_nome" placeholder="Nome do cliente">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Telefone</label>
                        <input type="text" class="form-control" name="cliente_telefone" placeholder="(11) 99999-9999">
                    </div>
                </div>
            </div>
            
            <!-- Informações do cliente selecionado -->
            <div id="cliente-selecionado-info" class="col-12" style="display: none;">
                <div class="border rounded p-3 bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1" id="cliente-nome"></h6>
                            <small class="text-muted">
                                <i class="fas fa-phone me-1"></i><span id="cliente-telefone"></span>
                                <span id="cliente-stats" class="ms-3"></span>
                            </small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="btn-remover-cliente">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="cliente-endereco" class="mt-2" style="display: none;">
                        <small class="text-muted">
                            <i class="fas fa-map-marker-alt me-1"></i><span id="endereco-texto"></span>
                        </small>
                    </div>
                </div>
            </div>
          </div>

          <h6>Itens do Pedido</h6>
          <div class="border rounded p-3 mb-2">
            <div id="itens-pedido-lista"></div>
            <button type="button" class="btn btn-outline-secondary" id="btn-add-item">
              <i class="fas fa-plus me-2"></i>Adicionar Item
            </button>
          </div>

          <div class="d-flex justify-content-end">
            <h5>Subtotal: R$ <span id="subtotal">0.00</span></h5>
          </div>

          <hr>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Forma de Pagamento</label>
              <select class="form-select" name="forma_pagamento" required>
                <option value="DIN">Dinheiro</option>
                <option value="PIX">Pix</option>
                <option value="CC">Cartão Crédito</option>
                <option value="CD">Cartão Débito</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Observações Gerais do Pedido</label>
              <textarea class="form-control" name="observacoes" rows="2" placeholder="Ex.: Entrega no portão dos fundos, sem cebola na pizza margherita"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between align-items-center">
          <div>
            <strong>Total: R$ <span id="total-geral">0.00</span></strong>
          </div>
          <div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-orange">Salvar Pedido</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Detalhes do Pedido -->
<div class="modal fade" id="modalDetalhesPedido" tabindex="-1" aria-labelledby="modalDetalhesPedidoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalhesPedidoLabel">Detalhes do Pedido #<span id="detalhes-pedido-id"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Cliente:</strong> <span id="detalhes-cliente"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Telefone:</strong> <span id="detalhes-telefone"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Data/Hora:</strong> <span id="detalhes-data"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong> <span id="detalhes-status" class="badge"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Forma de Pagamento:</strong> <span id="detalhes-pagamento"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Total:</strong> <span id="detalhes-total" class="fw-bold text-success"></span>
                    </div>
                </div>
                
                <div class="mb-3" id="detalhes-observacoes-container">
                    <strong>Observações:</strong>
                    <div class="mt-1 p-2 bg-light rounded" id="detalhes-observacoes"></div>
                </div>

                <h6>Itens do Pedido:</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Qtd.</th>
                                <th>Valor Unit.</th>
                                <th>Subtotal</th>
                                <th>Observações</th>
                            </tr>
                        </thead>
                        <tbody id="detalhes-itens">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Pedido -->
<div class="modal fade" id="modalEditarPedido" tabindex="-1" aria-labelledby="modalEditarPedidoLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <form id="formEditarPedido">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarPedidoLabel">Editar Pedido #<span id="edit-pedido-id"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <label class="form-label">Cliente</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="edit-busca-cliente" placeholder="Digite nome ou telefone para buscar cliente..." autocomplete="off">
                                <button type="button" class="btn btn-outline-secondary" id="edit-btn-cliente-novo">
                                    <i class="fas fa-user-plus"></i> Novo
                                </button>
                            </div>
                            <div id="edit-lista-clientes" class="position-absolute w-100 bg-white border rounded-bottom shadow-sm" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                        </div>
                        
                        <!-- Cliente selecionado (hidden) -->
                        <input type="hidden" id="edit-cliente-selecionado-id" name="cliente_id">
                        
                        <!-- Campos para cliente não cadastrado -->
                        <div id="edit-campos-cliente-novo" class="col-12" style="display: none;">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Nome do Cliente</label>
                                    <input type="text" class="form-control" id="edit-cliente-nome" name="cliente_nome" placeholder="Nome do cliente">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Telefone</label>
                                    <input type="text" class="form-control" id="edit-cliente-telefone" name="cliente_telefone" placeholder="(11) 99999-9999">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informações do cliente selecionado -->
                        <div id="edit-cliente-selecionado-info" class="col-12" style="display: none;">
                            <div class="border rounded p-3 bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1" id="edit-cliente-nome-display"></h6>
                                        <small class="text-muted">
                                            <i class="fas fa-phone me-1"></i><span id="edit-cliente-telefone-display"></span>
                                            <span id="edit-cliente-stats" class="ms-3"></span>
                                        </small>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="edit-btn-remover-cliente">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div id="edit-cliente-endereco" class="mt-2" style="display: none;">
                                    <small class="text-muted">
                                        <i class="fas fa-map-marker-alt me-1"></i><span id="edit-endereco-texto"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h6>Itens do Pedido</h6>
                    <div class="border rounded p-3 mb-2">
                        <div id="edit-itens-pedido-lista"></div>
                        <button type="button" class="btn btn-outline-secondary" id="btn-edit-add-item">
                            <i class="fas fa-plus me-2"></i>Adicionar Item
                        </button>
                    </div>

                    <div class="d-flex justify-content-end">
                        <h5>Subtotal: R$ <span id="edit-subtotal">0.00</span></h5>
                    </div>

                    <hr>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Forma de Pagamento</label>
                            <select class="form-select" id="edit-forma-pagamento" name="forma_pagamento" required>
                                <option value="DIN">Dinheiro</option>
                                <option value="PIX">Pix</option>
                                <option value="CC">Cartão Crédito</option>
                                <option value="CD">Cartão Débito</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Observações Gerais do Pedido</label>
                            <textarea class="form-control" id="edit-observacoes" name="observacoes" rows="2" placeholder="Ex.: Entrega no portão dos fundos"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Total: R$ <span id="edit-total-geral">0.00</span></strong>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-orange">
                            <i class="fas fa-save me-2"></i>Salvar Alterações
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let itemCount = 0;
const produtos = [
  {% for p in produtos_disponiveis %}
    {id: {{ p.id }}, nome: "{{ p.nome|escapejs }}", preco: {{ p.preco_atual }}},
  {% endfor %}
];

function atualizarTotais() {
  const subtotalSpan = document.getElementById('subtotal');
  const totalSpan = document.getElementById('total-geral');
  let subtotal = 0;
  document.querySelectorAll('.item-row').forEach(row => {
    const preco = parseFloat(row.dataset.preco);
    const qtd = parseFloat(row.querySelector('.qtd-input').value) || 0;
    subtotal += preco * qtd;
  });
  subtotalSpan.textContent = subtotal.toFixed(2);
  totalSpan.textContent = subtotal.toFixed(2); // Sem taxa por enquanto
}

document.getElementById('btn-add-item').addEventListener('click', () => {
  itemCount++;
  const lista = document.getElementById('itens-pedido-lista');
  const row = document.createElement('div');
  row.className = 'row g-2 align-items-end mb-2 item-row';
  row.dataset.preco = 0;
  row.innerHTML = `
    <div class="col-md-5">
      <label class="form-label">Produto</label>
      <select class="form-select prod-select" name="item_produto_${itemCount}" required>
        <option value="">Selecione</option>
        ${produtos.map(p => `<option value="${p.id}" data-preco="${p.preco}">${p.nome}</option>`).join('')}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Qtd.</label>
      <input type="number" min="1" value="1" class="form-control qtd-input" name="item_qtd_${itemCount}" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Observações do Item</label>
      <input type="text" class="form-control" name="item_obs_${itemCount}" placeholder="Ex.: Sem queijo">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="this.closest('.item-row').remove(); atualizarTotais();"><i class="fas fa-trash"></i></button>
    </div>
  `;
  lista.appendChild(row);

  // Eventos para atualizar preço
  row.querySelector('.prod-select').addEventListener('change', function() {
    const price = parseFloat(this.selectedOptions[0].dataset.preco || 0);
    row.dataset.preco = price;
    atualizarTotais();
  });
  row.querySelector('.qtd-input').addEventListener('input', atualizarTotais);
});

// Inicializar tooltips do Bootstrap
document.addEventListener('DOMContentLoaded', function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  // ==================== INTEGRAÇÃO COM CLIENTES ====================
  let clienteTimeout;
  const buscaClienteInput = document.getElementById('busca-cliente');
  const listaClientes = document.getElementById('lista-clientes');
  const clienteSelecionadoId = document.getElementById('cliente-selecionado-id');
  const clienteSelecionadoInfo = document.getElementById('cliente-selecionado-info');
  const camposClienteNovo = document.getElementById('campos-cliente-novo');
  
  // Busca de clientes
  if (buscaClienteInput) {
    buscaClienteInput.addEventListener('input', function() {
      const termo = this.value.trim();
      
      clearTimeout(clienteTimeout);
      
      if (termo.length < 2) {
        listaClientes.style.display = 'none';
        return;
      }
      
      clienteTimeout = setTimeout(() => {
        fetch(`/clientes/buscar/?termo=${encodeURIComponent(termo)}`)
          .then(response => response.json())
          .then(data => {
            listaClientes.innerHTML = '';
            
            if (data.clientes.length > 0) {
              data.clientes.forEach(cliente => {
                const div = document.createElement('div');
                div.className = 'p-2 border-bottom cliente-item';
                div.style.cursor = 'pointer';
                div.innerHTML = `
                  <div class="d-flex justify-content-between">
                    <div>
                      <strong>${cliente.nome}</strong>
                      <br><small class="text-muted">${cliente.telefone}</small>
                    </div>
                    <div class="text-end">
                      <small class="text-success">${cliente.total_pedidos} pedidos</small>
                      <br><small class="text-primary">R$ ${cliente.total_gasto.toFixed(2)}</small>
                    </div>
                  </div>
                  ${cliente.endereco_principal ? `<small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>${cliente.endereco_principal}</small>` : ''}
                `;
                
                div.addEventListener('click', () => selecionarCliente(cliente));
                listaClientes.appendChild(div);
              });
              
              listaClientes.style.display = 'block';
            } else {
              listaClientes.innerHTML = '<div class="p-2 text-muted">Nenhum cliente encontrado</div>';
              listaClientes.style.display = 'block';
            }
          })
          .catch(error => {
            console.error('Erro ao buscar clientes:', error);
            listaClientes.style.display = 'none';
          });
      }, 300);
    });
    
    // Esconder lista ao clicar fora
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#busca-cliente') && !e.target.closest('#lista-clientes')) {
        listaClientes.style.display = 'none';
      }
    });
  }
  
  // Função para selecionar cliente
  function selecionarCliente(cliente) {
    clienteSelecionadoId.value = cliente.id;
    buscaClienteInput.value = '';
    listaClientes.style.display = 'none';
    
    // Mostrar informações do cliente
    document.getElementById('cliente-nome').textContent = cliente.nome;
    document.getElementById('cliente-telefone').textContent = cliente.telefone;
    document.getElementById('cliente-stats').textContent = `${cliente.total_pedidos} pedidos • R$ ${cliente.total_gasto.toFixed(2)} gastos`;
    
    if (cliente.endereco_principal) {
      document.getElementById('endereco-texto').textContent = cliente.endereco_principal;
      document.getElementById('cliente-endereco').style.display = 'block';
    } else {
      document.getElementById('cliente-endereco').style.display = 'none';
    }
    
    clienteSelecionadoInfo.style.display = 'block';
    camposClienteNovo.style.display = 'none';
  }
  
  // Botão "Novo Cliente"
  document.getElementById('btn-cliente-novo')?.addEventListener('click', function() {
    clienteSelecionadoId.value = '';
    buscaClienteInput.value = '';
    listaClientes.style.display = 'none';
    clienteSelecionadoInfo.style.display = 'none';
    camposClienteNovo.style.display = 'block';
  });
  
  // Botão "Remover Cliente"
  document.getElementById('btn-remover-cliente')?.addEventListener('click', function() {
    clienteSelecionadoId.value = '';
    buscaClienteInput.value = '';
    clienteSelecionadoInfo.style.display = 'none';
    camposClienteNovo.style.display = 'none';
  });
  
  // ==================== INTEGRAÇÃO COM CLIENTES - MODAL EDITAR ====================
  let editClienteTimeout;
  const editBuscaClienteInput = document.getElementById('edit-busca-cliente');
  const editListaClientes = document.getElementById('edit-lista-clientes');
  const editClienteSelecionadoId = document.getElementById('edit-cliente-selecionado-id');
  const editClienteSelecionadoInfo = document.getElementById('edit-cliente-selecionado-info');
  const editCamposClienteNovo = document.getElementById('edit-campos-cliente-novo');
  
  // Busca de clientes no modal de editar
  if (editBuscaClienteInput) {
    editBuscaClienteInput.addEventListener('input', function() {
      const termo = this.value.trim();
      
      clearTimeout(editClienteTimeout);
      
      if (termo.length < 2) {
        editListaClientes.style.display = 'none';
        return;
      }
      
      editClienteTimeout = setTimeout(() => {
        fetch(`/clientes/buscar/?termo=${encodeURIComponent(termo)}`)
          .then(response => response.json())
          .then(data => {
            editListaClientes.innerHTML = '';
            
            if (data.clientes.length > 0) {
              data.clientes.forEach(cliente => {
                const div = document.createElement('div');
                div.className = 'p-2 border-bottom cliente-item';
                div.style.cursor = 'pointer';
                div.innerHTML = `
                  <div class="d-flex justify-content-between">
                    <div>
                      <strong>${cliente.nome}</strong>
                      <br><small class="text-muted">${cliente.telefone}</small>
                    </div>
                    <div class="text-end">
                      <small class="text-success">${cliente.total_pedidos} pedidos</small>
                      <br><small class="text-primary">R$ ${cliente.total_gasto.toFixed(2)}</small>
                    </div>
                  </div>
                  ${cliente.endereco_principal ? `<small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>${cliente.endereco_principal}</small>` : ''}
                `;
                
                div.addEventListener('click', () => editSelecionarCliente(cliente));
                editListaClientes.appendChild(div);
              });
              
              editListaClientes.style.display = 'block';
            } else {
              editListaClientes.innerHTML = '<div class="p-2 text-muted">Nenhum cliente encontrado</div>';
              editListaClientes.style.display = 'block';
            }
          })
          .catch(error => {
            console.error('Erro ao buscar clientes:', error);
            editListaClientes.style.display = 'none';
          });
      }, 300);
    });
    
    // Esconder lista ao clicar fora
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#edit-busca-cliente') && !e.target.closest('#edit-lista-clientes')) {
        editListaClientes.style.display = 'none';
      }
    });
  }
  
  // Função para selecionar cliente no modal de editar
  function editSelecionarCliente(cliente) {
    editClienteSelecionadoId.value = cliente.id;
    editBuscaClienteInput.value = '';
    editListaClientes.style.display = 'none';
    
    // Mostrar informações do cliente
    document.getElementById('edit-cliente-nome-display').textContent = cliente.nome;
    document.getElementById('edit-cliente-telefone-display').textContent = cliente.telefone;
    document.getElementById('edit-cliente-stats').textContent = `${cliente.total_pedidos} pedidos • R$ ${cliente.total_gasto.toFixed(2)} gastos`;
    
    if (cliente.endereco_principal) {
      document.getElementById('edit-endereco-texto').textContent = cliente.endereco_principal;
      document.getElementById('edit-cliente-endereco').style.display = 'block';
    } else {
      document.getElementById('edit-cliente-endereco').style.display = 'none';
    }
    
    editClienteSelecionadoInfo.style.display = 'block';
    editCamposClienteNovo.style.display = 'none';
    
    // Limpar campos de cliente novo
    document.getElementById('edit-cliente-nome').value = '';
    document.getElementById('edit-cliente-telefone').value = '';
  }
  
  // Botão "Novo Cliente" no modal de editar
  document.getElementById('edit-btn-cliente-novo')?.addEventListener('click', function() {
    editClienteSelecionadoId.value = '';
    editBuscaClienteInput.value = '';
    editListaClientes.style.display = 'none';
    editClienteSelecionadoInfo.style.display = 'none';
    editCamposClienteNovo.style.display = 'block';
  });
  
  // Botão "Remover Cliente" no modal de editar
  document.getElementById('edit-btn-remover-cliente')?.addEventListener('click', function() {
    editClienteSelecionadoId.value = '';
    editBuscaClienteInput.value = '';
    editClienteSelecionadoInfo.style.display = 'none';
    editCamposClienteNovo.style.display = 'none';
  });
});

// Função para alterar status do pedido
function alterarStatus(pedidoId, novoStatus, statusNome, elemento) {
  if (confirm(`Alterar status do pedido #${pedidoId} para "${statusNome}"?`)) {
    // Mostrar loading no elemento
    const originalContent = elemento.innerHTML;
    elemento.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    elemento.disabled = true;
    
    // Fazer requisição AJAX
    fetch(`/pedidos/${pedidoId}/alterar-status/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: `status=${novoStatus}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Recarregar a página para atualizar a interface
        location.reload();
      } else {
        alert('Erro: ' + (data.error || 'Erro desconhecido'));
        elemento.innerHTML = originalContent;
        elemento.disabled = false;
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao alterar status do pedido');
      elemento.innerHTML = originalContent;
      elemento.disabled = false;
    });
  }
}

// Event listeners
document.addEventListener('click', function(e) {
  // Dropdown de status
  if (e.target.classList.contains('alterar-status')) {
    e.preventDefault();
    
    const pedidoId = e.target.getAttribute('data-pedido-id');
    const novoStatus = e.target.getAttribute('data-status');
    const statusNome = e.target.textContent.trim();
    
    alterarStatus(pedidoId, novoStatus, statusNome, e.target);
  }
  
  // Botões de ação rápida
  if (e.target.closest('.quick-status')) {
    e.preventDefault();
    
    const button = e.target.closest('.quick-status');
    const pedidoId = button.getAttribute('data-pedido-id');
    const novoStatus = button.getAttribute('data-status');
    
    // Mapear status para nomes amigáveis
    const statusNames = {
      'EM_PREPARO': 'Em Preparo',
      'PRONTO': 'Pronto',
      'ENTREGUE': 'Entregue'
    };
    
    const statusNome = statusNames[novoStatus] || novoStatus;
    alterarStatus(pedidoId, novoStatus, statusNome, button);
  }
});

// Botão Ver Detalhes
document.addEventListener('click', function(e) {
  if (e.target.closest('.btn-detalhes')) {
    e.preventDefault();
    const pedidoId = e.target.closest('.btn-detalhes').getAttribute('data-pedido-id');
    
    // Carregar detalhes via AJAX
    fetch(`/pedidos/${pedidoId}/detalhes/`)
      .then(response => response.json())
      .then(data => {
        // Preencher modal com dados
        document.getElementById('detalhes-pedido-id').textContent = data.id;
        document.getElementById('detalhes-cliente').textContent = data.cliente_nome;
        document.getElementById('detalhes-telefone').textContent = data.cliente_telefone || 'Não informado';
        document.getElementById('detalhes-data').textContent = data.data_criacao;
        document.getElementById('detalhes-status').textContent = data.status;
        document.getElementById('detalhes-status').className = 'badge bg-primary';
        document.getElementById('detalhes-pagamento').textContent = data.forma_pagamento;
        document.getElementById('detalhes-total').textContent = 'R$ ' + parseFloat(data.total).toFixed(2);
        
        // Observações
        const obsContainer = document.getElementById('detalhes-observacoes-container');
        const obsElement = document.getElementById('detalhes-observacoes');
        if (data.observacoes) {
          obsContainer.style.display = 'block';
          obsElement.textContent = data.observacoes;
        } else {
          obsContainer.style.display = 'none';
        }
        
        // Itens
        const itensContainer = document.getElementById('detalhes-itens');
        itensContainer.innerHTML = '';
        data.itens.forEach(item => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${item.produto_nome}</td>
            <td>${item.quantidade}</td>
            <td>R$ ${parseFloat(item.valor_unitario).toFixed(2)}</td>
            <td>R$ ${parseFloat(item.subtotal).toFixed(2)}</td>
            <td>${item.observacao || '-'}</td>
          `;
          itensContainer.appendChild(row);
        });
        
        // Abrir modal
        new bootstrap.Modal(document.getElementById('modalDetalhesPedido')).show();
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao carregar detalhes do pedido');
      });
  }
});

// Botão Cancelar
document.addEventListener('click', function(e) {
  if (e.target.closest('.btn-cancelar')) {
    e.preventDefault();
    const pedidoId = e.target.closest('.btn-cancelar').getAttribute('data-pedido-id');
    
    if (confirm(`Tem certeza que deseja cancelar o pedido #${pedidoId}?`)) {
      fetch(`/pedidos/${pedidoId}/cancelar/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert('Erro: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao cancelar pedido');
      });
    }
  }
});

// Variáveis para edição
let editItemCount = 0;
let editProdutos = [];

// Botão Editar
document.addEventListener('click', function(e) {
  if (e.target.closest('.btn-editar')) {
    e.preventDefault();
    const pedidoId = e.target.closest('.btn-editar').getAttribute('data-pedido-id');
    
    // Carregar dados para edição
    fetch(`/pedidos/${pedidoId}/editar/`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert('Erro: ' + data.error);
          return;
        }
        
        // Preencher dados básicos
        document.getElementById('edit-pedido-id').textContent = data.id;
        document.getElementById('edit-forma-pagamento').value = data.forma_pagamento;
        document.getElementById('edit-observacoes').value = data.observacoes;
        
        // Configurar cliente
        if (data.cliente_id) {
          // Cliente cadastrado - simular seleção
          const clienteInfo = {
            id: data.cliente_id,
            nome: data.cliente_nome,
            telefone: data.cliente_telefone,
            endereco_principal: data.cliente_endereco || '',
            total_pedidos: data.cliente_total_pedidos || 0,
            total_gasto: data.cliente_total_gasto || 0
          };
          editSelecionarCliente(clienteInfo);
        } else {
          // Cliente não cadastrado - mostrar campos manuais
          document.getElementById('edit-cliente-nome').value = data.cliente_nome || '';
          document.getElementById('edit-cliente-telefone').value = data.cliente_telefone || '';
          document.getElementById('edit-btn-cliente-novo').click(); // Ativa modo "novo cliente"
        }
        
        // Guardar produtos disponíveis
        editProdutos = data.produtos_disponiveis;
        
        // Limpar e recriar itens
        const itensContainer = document.getElementById('edit-itens-pedido-lista');
        itensContainer.innerHTML = '';
        editItemCount = 0;
        
        // Adicionar itens existentes
        data.itens.forEach(item => {
          adicionarItemEdicao(item.produto_id, item.quantidade, item.observacao);
        });
        
        // Se não há itens, adicionar um vazio
        if (data.itens.length === 0) {
          adicionarItemEdicao();
        }
        
        // Calcular totais
        atualizarTotaisEdicao();
        
        // Abrir modal
        new bootstrap.Modal(document.getElementById('modalEditarPedido')).show();
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao carregar dados para edição');
      });
  }
});

// Função para adicionar item na edição
function adicionarItemEdicao(produtoId = '', quantidade = 1, observacao = '') {
  editItemCount++;
  
  const itensContainer = document.getElementById('edit-itens-pedido-lista');
  const row = document.createElement('div');
  row.className = 'row g-2 align-items-end mb-2 edit-item-row';
  row.dataset.preco = 0;
  
  const produtosOptions = editProdutos.map(p => 
    `<option value="${p.id}" data-preco="${p.preco}" ${p.id == produtoId ? 'selected' : ''}>${p.nome}</option>`
  ).join('');
  
  row.innerHTML = `
    <div class="col-md-5">
      <label class="form-label">Produto</label>
      <select class="form-select edit-prod-select" name="item_produto_${editItemCount}" required>
        <option value="">Selecione</option>
        ${produtosOptions}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Qtd.</label>
      <input type="number" min="1" value="${quantidade}" class="form-control edit-qtd-input" name="item_qtd_${editItemCount}" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Observações do Item</label>
      <input type="text" class="form-control" name="item_obs_${editItemCount}" value="${observacao}" placeholder="Ex.: Sem queijo">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="this.closest('.edit-item-row').remove(); atualizarTotaisEdicao();">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `;
  
  itensContainer.appendChild(row);
  
  // Definir preço se produto já selecionado
  const select = row.querySelector('.edit-prod-select');
  if (produtoId) {
    const selectedOption = select.querySelector(`option[value="${produtoId}"]`);
    if (selectedOption) {
      row.dataset.preco = selectedOption.dataset.preco;
    }
  }
  
  // Eventos
  select.addEventListener('change', function() {
    const price = parseFloat(this.selectedOptions[0].dataset.preco || 0);
    row.dataset.preco = price;
    atualizarTotaisEdicao();
  });
  
  row.querySelector('.edit-qtd-input').addEventListener('input', atualizarTotaisEdicao);
}

// Botão adicionar item na edição
document.getElementById('btn-edit-add-item').addEventListener('click', () => {
  adicionarItemEdicao();
});

// Função para atualizar totais na edição
function atualizarTotaisEdicao() {
  const subtotalSpan = document.getElementById('edit-subtotal');
  const totalSpan = document.getElementById('edit-total-geral');
  let subtotal = 0;
  
  document.querySelectorAll('.edit-item-row').forEach(row => {
    const preco = parseFloat(row.dataset.preco || 0);
    const qtd = parseFloat(row.querySelector('.edit-qtd-input').value) || 0;
    subtotal += preco * qtd;
  });
  
  subtotalSpan.textContent = subtotal.toFixed(2);
  totalSpan.textContent = subtotal.toFixed(2);
}

// Submit do formulário de edição
document.getElementById('formEditarPedido').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const pedidoId = document.getElementById('edit-pedido-id').textContent;
  const formData = new FormData(this);
  
  // Mostrar loading
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
  submitBtn.disabled = true;
  
  fetch(`/pedidos/${pedidoId}/editar/`, {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      bootstrap.Modal.getInstance(document.getElementById('modalEditarPedido')).hide();
      location.reload();
    } else {
      alert('Erro: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    alert('Erro ao salvar pedido');
  })
  .finally(() => {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  });
});
</script>

<style>
/* Estilos para os badges de status */
.status-badge-rascunho {
  background-color: #6c757d;
  color: white;
  border: none;
}

.status-badge-recebido {
  background-color: #ffc107;
  color: #212529;
  border: none;
}

.status-badge-em_preparo {
  background-color: #fd7e14;
  color: white;
  border: none;
}

.status-badge-pronto {
  background-color: #20c997;
  color: white;
  border: none;
}

.status-badge-entregue {
  background-color: #198754;
  color: white;
  border: none;
}

.status-badge-cancelado {
  background-color: #dc3545;
  color: white;
  border: none;
}

.status-badge-rascunho:hover,
.status-badge-recebido:hover,
.status-badge-em_preparo:hover,
.status-badge-pronto:hover,
.status-badge-entregue:hover,
.status-badge-cancelado:hover {
  opacity: 0.8;
}

/* Indicadores de status no dropdown */
.status-indicator {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 8px;
}

.status-rascunho { background-color: #6c757d; }
.status-recebido { background-color: #ffc107; }
.status-em_preparo { background-color: #fd7e14; }
.status-pronto { background-color: #20c997; }
.status-entregue { background-color: #198754; }
.status-cancelado { background-color: #dc3545; }

/* Botões de ação rápida */
.btn-xs {
  padding: 0.125rem 0.25rem;
  font-size: 0.75rem;
  line-height: 1;
  border-radius: 0.2rem;
}

.quick-status {
  transition: all 0.2s ease;
}

.quick-status:hover {
  transform: scale(1.1);
}

/* Melhorar dropdown para não precisar scroll */
.dropdown-menu {
  max-height: none !important;
  overflow: visible !important;
}

/* Forçar dropdown para cima quando necessário */
.table tbody tr:nth-last-child(-n+3) .dropdown {
  position: static;
}

.table tbody tr:nth-last-child(-n+3) .dropdown-menu {
  position: absolute;
  bottom: 100%;
  top: auto;
  transform: translateY(-5px);
}

/* Ajustar largura da coluna de status */
.table th:nth-child(5),
.table td:nth-child(5) {
  min-width: 140px;
  width: 140px;
}
</style>
{% endblock %}
