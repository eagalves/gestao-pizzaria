{% extends 'autenticacao/pizzaria_dashboard.html' %}

{% block title %}Gerenciar Preços - {{ produto.nome }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-dollar-sign me-2"></i>Gerenciar Preços</h2>
                    <p class="text-muted mb-0">{{ produto.nome }}</p>
                </div>
                <a href="{% url 'lista_produtos' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Voltar aos Produtos
                </a>
            </div>

            <div class="row">
                <!-- Formulário de Preços -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-edit me-2"></i>Definir Preços</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" id="form-precos">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.preco_base_reais.id_for_label }}" class="form-label">
                                                <i class="fas fa-tag me-2"></i>{{ form.preco_base_reais.label }}
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">R$</span>
                                                {{ form.preco_base_reais }}
                                            </div>
                                            {% if form.preco_base_reais.errors %}
                                                <div class="text-danger small mt-1">
                                                    {{ form.preco_base_reais.errors }}
                                                </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                {{ form.preco_base_reais.help_text }}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.preco_venda_reais.id_for_label }}" class="form-label">
                                                <i class="fas fa-shopping-cart me-2"></i>{{ form.preco_venda_reais.label }}
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">R$</span>
                                                {{ form.preco_venda_reais }}
                                            </div>
                                            {% if form.preco_venda_reais.errors %}
                                                <div class="text-danger small mt-1">
                                                    {{ form.preco_venda_reais.errors }}
                                                </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                {{ form.preco_venda_reais.help_text }}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cálculos Automáticos -->
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-calculator me-2"></i>Cálculos Automáticos</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Custo dos Ingredientes:</strong> 
                                                <span class="badge bg-secondary">R$ {{ custo_ingredientes|floatformat:2 }}</span>
                                            </p>
                                            <p class="mb-1"><strong>Custo Total:</strong> 
                                                <span id="custo-total" class="badge bg-warning">R$ 0,00</span>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Margem de Lucro:</strong> 
                                                <span id="margem-lucro" class="badge bg-success">0%</span>
                                            </p>
                                            <p class="mb-1"><strong>Lucro Líquido:</strong> 
                                                <span id="lucro-liquido" class="badge bg-primary">R$ 0,00</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'lista_produtos' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save me-2"></i>Salvar Preços
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Informações do Produto -->
                <div class="col-md-4">
                    <!-- Detalhes do Produto -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6><i class="fas fa-info-circle me-2"></i>Detalhes do Produto</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Nome:</strong> {{ produto.nome }}</p>
                            {% if produto.categoria %}
                                <p><strong>Categoria:</strong> {{ produto.categoria.nome }}</p>
                            {% endif %}
                            {% if produto.descricao %}
                                <p><strong>Descrição:</strong> {{ produto.descricao }}</p>
                            {% endif %}
                            <p><strong>Tempo de Preparo:</strong> {{ produto.tempo_preparo_minutos }} min</p>
                        </div>
                    </div>

                    <!-- Ingredientes -->
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-leaf me-2"></i>Ingredientes e Custos</h6>
                        </div>
                        <div class="card-body">
                            {% if ingredientes %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Ingrediente</th>
                                                <th>Qtd</th>
                                                <th>Custo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for pi in ingredientes %}
                                            <tr>
                                                <td>{{ pi.ingrediente.nome }}</td>
                                                <td>{{ pi.quantidade }} {{ pi.get_unidade_display }}</td>
                                                <td>
                                                    {% if pi.ingrediente.estoque %}
                                                        R$ {{ pi.ingrediente.estoque.preco_compra_atual|floatformat:2 }}
                                                    {% else %}
                                                        <span class="text-muted">N/D</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            <tr class="table-warning">
                                                <td colspan="2"><strong>Total Ingredientes:</strong></td>
                                                <td><strong>R$ {{ custo_ingredientes|floatformat:2 }}</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted mb-0">Este produto não possui ingredientes cadastrados.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Alertas -->
                    <div class="mt-4">
                        <div class="alert alert-warning" id="alerta-margem" style="display: none;">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Atenção!</h6>
                            <p class="mb-0">A margem de lucro está muito baixa. Considere ajustar os preços.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const precoBaseInput = document.getElementById('{{ form.preco_base_reais.id_for_label }}');
    const precoVendaInput = document.getElementById('{{ form.preco_venda_reais.id_for_label }}');
    const custoIngredientes = {{ custo_ingredientes }};
    
    const custoTotalSpan = document.getElementById('custo-total');
    const margemLucroSpan = document.getElementById('margem-lucro');
    const lucroLiquidoSpan = document.getElementById('lucro-liquido');
    const alertaMargem = document.getElementById('alerta-margem');

    function calcularPrecos() {
        const precoBase = parseFloat(precoBaseInput.value) || 0;
        const precoVenda = parseFloat(precoVendaInput.value) || 0;
        
        // Custo Total = Preço Base + Custo dos Ingredientes
        const custoTotal = precoBase + custoIngredientes;
        
        // Lucro = Preço Venda - Custo Total
        const lucro = precoVenda - custoTotal;
        
        // Margem = (Lucro / Preço Venda) * 100
        const margem = precoVenda > 0 ? (lucro / precoVenda) * 100 : 0;
        
        // Atualizar displays
        custoTotalSpan.textContent = `R$ ${custoTotal.toFixed(2)}`;
        margemLucroSpan.textContent = `${margem.toFixed(1)}%`;
        lucroLiquidoSpan.textContent = `R$ ${lucro.toFixed(2)}`;
        
        // Alterar cores baseado na margem
        if (margem < 50) {
            margemLucroSpan.className = 'badge bg-danger';
            alertaMargem.style.display = 'block';
        } else if (margem < 100) {
            margemLucroSpan.className = 'badge bg-warning';
            alertaMargem.style.display = 'none';
        } else {
            margemLucroSpan.className = 'badge bg-success';
            alertaMargem.style.display = 'none';
        }
        
        // Alterar cor do lucro
        if (lucro < 0) {
            lucroLiquidoSpan.className = 'badge bg-danger';
        } else if (lucro < 5) {
            lucroLiquidoSpan.className = 'badge bg-warning';
        } else {
            lucroLiquidoSpan.className = 'badge bg-success';
        }
    }

    // Event listeners
    precoBaseInput.addEventListener('input', calcularPrecos);
    precoVendaInput.addEventListener('input', calcularPrecos);

    // Calcular inicial
    calcularPrecos();
});
</script>

<style>
.table-sm th, .table-sm td {
    padding: 0.25rem;
    font-size: 0.875rem;
}

.badge {
    font-size: 0.8em;
}
</style>
{% endblock %}
