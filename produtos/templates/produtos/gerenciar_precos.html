{% extends 'autenticacao/pizzaria_dashboard.html' %}

{% block title %}Gerenciar Preços - {{ produto.nome }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-dollar-sign me-2"></i>Gerenciar Preços</h2>
                    <p class="text-muted mb-0">{{ produto.nome }}</p>
                </div>
                <a href="{% url 'lista_produtos' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Voltar aos Produtos
                </a>
            </div>

            <div class="row">
                <!-- Formulário de Preços -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-edit me-2"></i>Definir Preços</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" id="form-precos">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.preco_base_reais.id_for_label }}" class="form-label">
                                                <i class="fas fa-tag me-2"></i>{{ form.preco_base_reais.label }}
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">R$</span>
                                                {{ form.preco_base_reais }}
                                            </div>
                                            {% if form.preco_base_reais.errors %}
                                                <div class="text-danger small mt-1">
                                                    {{ form.preco_base_reais.errors }}
                                                </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                {{ form.preco_base_reais.help_text }}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.preco_venda_reais.id_for_label }}" class="form-label">
                                                <i class="fas fa-shopping-cart me-2"></i>{{ form.preco_venda_reais.label }}
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">R$</span>
                                                {{ form.preco_venda_reais }}
                                            </div>
                                            {% if form.preco_venda_reais.errors %}
                                                <div class="text-danger small mt-1">
                                                    {{ form.preco_venda_reais.errors }}
                                                </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                {{ form.preco_venda_reais.help_text }}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cálculos Automáticos -->
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-calculator me-2"></i>Análise de Rentabilidade</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Custo dos Ingredientes:</strong> 
                                                <span class="badge bg-secondary">R$ {{ produto.custo_ingredientes|floatformat:2 }}</span>
                                            </p>
                                            <p class="mb-1"><strong>Custo Total:</strong> 
                                                <span id="custo-total" class="badge bg-warning">R$ 0,00</span>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Margem de Lucro:</strong> 
                                                <span id="margem-lucro" class="badge bg-success">0%</span>
                                            </p>
                                            <p class="mb-1"><strong>Lucro Líquido:</strong> 
                                                <span id="lucro-liquido" class="badge bg-primary">R$ 0,00</span>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            <strong>Custo Total</strong> = Preço Base + Custo dos Ingredientes<br>
                                            <strong>Margem</strong> = (Preço Venda - Custo Total) ÷ Preço Venda × 100%
                                        </small>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'lista_produtos' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save me-2"></i>Salvar Preços
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Informações do Produto -->
                <div class="col-md-4">
                    <!-- Detalhes do Produto -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6><i class="fas fa-info-circle me-2"></i>Detalhes do Produto</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Nome:</strong> {{ produto.nome }}</p>
                            {% if produto.categoria %}
                                <p><strong>Categoria:</strong> {{ produto.categoria.nome }}</p>
                            {% endif %}
                            {% if produto.descricao %}
                                <p><strong>Descrição:</strong> {{ produto.descricao }}</p>
                            {% endif %}
                            <p><strong>Tempo de Preparo:</strong> {{ produto.tempo_preparo_minutos }} min</p>
                        </div>
                    </div>

                    <!-- Ingredientes -->
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-leaf me-2"></i>Ingredientes e Custos</h6>
                        </div>
                        <div class="card-body">
                            {% if ingredientes %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Ingrediente</th>
                                                <th>Qtd</th>
                                                <th>Custo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for pi in ingredientes %}
                                            <tr>
                                                <td>{{ pi.ingrediente.nome }}</td>
                                                <td>{{ pi.quantidade }} {{ pi.get_unidade_display }}</td>
                                                <td>
                                                    {% if pi.custo > 0 %}
                                                        R$ {{ pi.custo|floatformat:2 }}
                                                    {% else %}
                                                        <span class="text-muted">N/D</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            <tr class="table-warning">
                                                <td colspan="2"><strong>Total Ingredientes:</strong></td>
                                                <td><strong>R$ {{ produto.custo_ingredientes|floatformat:2 }}</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted mb-0">Este produto não possui ingredientes cadastrados.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Alertas -->
                    <div class="mt-4">
                        <div class="alert alert-danger" id="alerta-prejuizo" style="display: none;">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>⚠️ Atenção: Prejuízo!</h6>
                            <p class="mb-0">O preço de venda não cobre os custos. Você pode salvar mesmo assim, mas terá prejuízo neste produto.</p>
                        </div>
                        
                        <div class="alert alert-warning" id="alerta-margem-baixa" style="display: none;">
                            <h6><i class="fas fa-info-circle me-2"></i>💡 Dica: Margem Baixa!</h6>
                            <p class="mb-0">A margem de lucro está baixa (menos de 30%). Você pode salvar, mas considere aumentar o preço se possível.</p>
                        </div>
                        
                        <div class="alert alert-success" id="alerta-margem-boa" style="display: none;">
                            <h6><i class="fas fa-check-circle me-2"></i>✅ Excelente!</h6>
                            <p class="mb-0">Margem de lucro saudável (50% ou mais). Produto bem precificado!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const precoBaseInput = document.getElementById('{{ form.preco_base_reais.id_for_label }}');
    const precoVendaInput = document.getElementById('{{ form.preco_venda_reais.id_for_label }}');
    const custoIngredientesCentavos = {{ produto.custo_ingredientes_centavos }};
    
    const custoTotalSpan = document.getElementById('custo-total');
    const margemLucroSpan = document.getElementById('margem-lucro');
    const lucroLiquidoSpan = document.getElementById('lucro-liquido');
    const alertaPrejuizo = document.getElementById('alerta-prejuizo');
    const alertaMargemBaixa = document.getElementById('alerta-margem-baixa');
    const alertaMargemBoa = document.getElementById('alerta-margem-boa');

    function calcularPrecos() {
        const precoBaseReais = parseFloat(precoBaseInput.value) || 0;
        const precoVendaReais = parseFloat(precoVendaInput.value) || 0;
        
        // Converter para centavos (inteiros)
        const precoBaseCentavos = Math.round(precoBaseReais * 100);
        const precoVendaCentavos = Math.round(precoVendaReais * 100);
        
        // Custo Total = Preço Base + Custo dos Ingredientes (tudo em centavos)
        const custoTotalCentavos = precoBaseCentavos + custoIngredientesCentavos;
        
        // Lucro = Preço Venda - Custo Total (em centavos)
        const lucroCentavos = precoVendaCentavos - custoTotalCentavos;
        
        // Margem = (Lucro / Preço Venda) * 100
        const margem = precoVendaCentavos > 0 ? (lucroCentavos / precoVendaCentavos) * 100 : 0;
        
        // Converter para reais para exibição
        const custoTotalReais = custoTotalCentavos / 100;
        const lucroReais = lucroCentavos / 100;
        
        // Atualizar displays
        custoTotalSpan.textContent = `R$ ${custoTotalReais.toFixed(2)}`;
        margemLucroSpan.textContent = `${margem.toFixed(1)}%`;
        lucroLiquidoSpan.textContent = `R$ ${lucroReais.toFixed(2)}`;
        
        // Esconder todos os alertas
        alertaPrejuizo.style.display = 'none';
        alertaMargemBaixa.style.display = 'none';
        alertaMargemBoa.style.display = 'none';
        
        // Alterar cores e alertas baseado na situação
        if (lucroCentavos < 0) {
            // PREJUÍZO (vermelho)
            margemLucroSpan.className = 'badge bg-danger';
            lucroLiquidoSpan.className = 'badge bg-danger';
            alertaPrejuizo.style.display = 'block';
        } else if (margem < 20) {
            // MARGEM RUIM (laranja)
            margemLucroSpan.className = 'badge bg-orange';
            lucroLiquidoSpan.className = 'badge bg-orange';
            alertaMargemBaixa.style.display = 'block';
        } else if (margem < 40) {
            // MARGEM BAIXA (amarelo)
            margemLucroSpan.className = 'badge bg-warning';
            lucroLiquidoSpan.className = 'badge bg-warning';
            alertaMargemBaixa.style.display = 'block';
        } else {
            // MARGEM BOA (verde)
            margemLucroSpan.className = 'badge bg-success';
            lucroLiquidoSpan.className = 'badge bg-success';
            alertaMargemBoa.style.display = 'block';
        }
        
        // Botão habilitado se pelo menos o preço de venda estiver preenchido
        const submitBtn = document.querySelector('button[type="submit"]');
        if (precoVendaReais > 0) {
            // Habilitado se tiver preço de venda (preço base pode ser 0)
            submitBtn.disabled = false;
            submitBtn.className = 'btn btn-success'; // SEMPRE VERDE
            
            if (lucroCentavos < 0) {
                // Prejuízo - botão verde mas com texto informativo
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Salvar (Prejuízo)';
                submitBtn.title = 'Atenção: Este preço gerará prejuízo!';
            } else if (margem < 20) {
                // Margem ruim
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Salvar (Margem Ruim)';
                submitBtn.title = 'Atenção: Margem ruim!';
            } else if (margem < 40) {
                // Margem baixa - botão verde mas com texto informativo
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Salvar (Margem Baixa)';
                submitBtn.title = 'Atenção: Margem muito baixa!';
            } else {
                // Margem boa - botão verde com texto padrão
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Preços';
                submitBtn.title = 'Preços com margem adequada';
            }
        } else {
            // Só desabilitar se não tiver preço de venda informado
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Preços';
            submitBtn.className = 'btn btn-secondary';
        }
    }

    // Event listeners
    precoBaseInput.addEventListener('input', calcularPrecos);
    precoVendaInput.addEventListener('input', calcularPrecos);

    // Calcular inicial
    calcularPrecos();
});
</script>

<style>
.table-sm th, .table-sm td {
    padding: 0.25rem;
    font-size: 0.875rem;
}

.badge {
    font-size: 0.8em;
}

/* Cor laranja para margem ruim */
.bg-orange {
    background-color: #fd7e14 !important;
    color: #fff !important;
}
</style>
{% endblock %}
